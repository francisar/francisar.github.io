<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>python eval踩坑后 | francisar&#39;s Blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="francisar's Blog">
    <meta name="author" content="franciscui">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="francisar&#39;s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/idea.css" type="text/css">
    
    

    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->
    <script src="/qunee/js/qunee-min.js"></script>
    <script src="/qunee/js/graphs.js"></script>
<script src="/qunee/js/qunee-functions.js"></script>
    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>


    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
<SCRIPT type=text/javascript src="/js/calendar.js"></SCRIPT>

<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f0d00aef190bb797f0d2ba4105e6200f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/K8S/" class="animsition-link">K8S<small>(3)</small></a></li>
				    
				    <li><a href="/categories/hadoop/" class="animsition-link">hadoop<small>(1)</small></a></li>
				    
				    <li><a href="/categories/ldap/" class="animsition-link">ldap<small>(1)</small></a></li>
				    
				    <li><a href="/categories/python/" class="animsition-link">python<small>(2)</small></a></li>
				    
				    <li><a href="/categories/subversion/" class="animsition-link">subversion<small>(1)</small></a></li>
				    
				    <li><a href="/categories/网络技术/" class="animsition-link">网络技术<small>(3)</small></a></li>
				    
				</ul>
        	</li>
			
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">francisar's Blog</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/francisar" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/cpf382607308" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            
                            
                            <li><a href="http://weibo.com/u/2465175025/home" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->

        <!-- ============================ Hero Image =========================== -->

        <section id="hero" class="scrollme">
            <div class="container-fluid element-img" style="background: url(/img/bg_img.jpg) no-repeat center center fixed;background-size: cover">
                <div class="row">
                    <div class="col-xs-12 col-sm-8 col-sm-offset-2 col-md-8 col-md-offset-2 vertical-align cover boost text-center">
                        <div class="center-me animateme" data-when="exit" data-from="0" data-to="0.6" data-opacity="0" data-translatey="100">
                            <div>
                            	
                                <h2>The wise man builds no hopes for the future, entertains no regrets for the past.</h2>
                                <p></p>
				    			
                                <h2></h2>
                                <p>既然目标是地平线 留给世界的只能是背影。</p>
				    			

                            </div>
                        </div>
                    </div>
                    <!-- // .col-md-12 -->
                </div>
                <div class="herofade beige-dk"></div>
            </div>
        </section>

        <!-- Height spacing helper -->
        <div class="heightblock"></div>
        <!-- // End height spacing helper -->

        <!-- ============================ END Hero Image =========================== -->
      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2016-03-31T05:14:00.000Z" itemprop="datePublished">
          2016-03-31
      </time>
    
    
    | 
    <a href='/tags/python-LEGB-eval/'>python LEGB eval</a>
    
    
</span>
                <h1>python eval踩坑后</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>最近在做一个数据采集的功能，每5分钟采集一次数据，由于数据是从日志中采集分析，通过crontab给spark提交任务去计算的，spark任务无法保证是在整5分钟间隔的时候执行（比如：00分，5分，10分），所以需要对当前时间做下处理，将非整5分钟的时间修改为整5分钟，然后做日志筛选<br>时间处理的具体代码如下:<br><!--lang:python--></p>
<pre><code>now = time.time() - 300                                   #当前时间延后5分钟 
daypath = time.strftime(&quot;%Y%m%d&quot;,time.localtime(now))     #取当天的日志路径
hour = time.strftime(&quot;%H%M&quot;,time.localtime(now))          #取小时分钟
minute = eval(hour)                                       #讲小时分钟转换为数字 
minute = minute - (minute % 5)                            #将分钟对5取模，减去余数
rowkey = &quot;%s%04d&quot; % (daypath,minute)                      #生成hbase rowkey(201603301320)
end = time.mktime(time.strptime(rowkey,&apos;%Y%m%d%H%M&apos;))     #将rowkey换算为时间戳 
begin = end - 300                                         #取begin到end之间的日志
</code></pre><p>以上代码在白天运行时毫无问题，但是到凌晨一点开始，没有计算没有数据了<br>经过分析发现，minute = eval(hour) 在晚上1点开始的时候，假设hour是0115，eval转换时会将hour视为八进制的数字，所以转换以后是163<br>minute = minute - (minute % 5)后，minute变为160，rowkey = “%s%04d” % (daypath,minute） 执行后，rowkey为201603300160，时间完全错<br>了，自然筛选不到日志</p>
<h2 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h2><!--lang:python-->
<pre><code>eval(expression[, globals[, locals]])
</code></pre><p>The expression argument is parsed and evaluated as a Python expression (technically speaking, a condition list) using the globals and locals dictionaries as global and local namespace. If the globals dictionary is present and lacks ‘<strong>builtins</strong>’, the current globals are copied into globals before expression is parsed. This means that expression normally has full access to the standard <strong>builtin</strong> module and restricted environments are propagated. If the locals dictionary is omitted it defaults to the globals dictionary. If both dictionaries are omitted, the expression is executed in the environment where eval() is called. The return value is the result of the evaluated expression.</p>
<p>expression参数会被解析为python表达式来执行，eval有三个参数，expression，globals，locals，globals和locals可选，传入字典，分别对应expression全局命名空间和局部命名空间，globals传入的字典中如果没有<strong>builtins</strong>，当前全局<strong>builtins</strong>将会在expression执行前传入globals</p>
<h2 id="python变量解析原则"><a href="#python变量解析原则" class="headerlink" title="python变量解析原则"></a>python变量解析原则</h2><p>我们都知道python变量名解析遵循LEGB原则，即首先是本地,之后是函数内，之后是全局，最后是内置。<br>在默认的情况下，变量名赋值会创建或者改变本地变量当函数中使用未认证的变量名时，Python就会搜索4个作用域（本地作用域，之后是上一层结构中def或lambda的本地作用域，之后是全局作用域，最后是内置作用域。<br>以下面代码为例:<br><!--lang:python--></p>
<pre><code>g = &apos;I am global&apos;
def local():
    e = &apos;I am function&apos;
    if g is not None:
        l = &apos;I am local&apos;
        print g,e,l,len(g)
</code></pre><p>代码1-1</p>
<p>从如上代码看：<br>在print g,e,l执行时，l来自本地变量，e来自函数内变量，g为全局变量,那么什么是内置变量呢，内置变量就是上面所说的<strong>builtins</strong>相关，而len(g)中的len来自内置变量</p>
<h2 id="python内置变量"><a href="#python内置变量" class="headerlink" title="python内置变量"></a>python内置变量</h2><p>在Python中，有一个内建模块，该模块中有一些常用函数;而该模块在Python启动后、且没有执行程序员所写的任何代码前，Python会首先加载该内建函数到内存。另外，该内建模块中的功能可以直接使用，不用在其前添加内建模块前缀。比如：内建模块中有一个len()函数，计算一个对象的长度，如len(‘aaa’)将返回3。</p>
<p>在Python2.X版本中，内建模块被命名为<strong>builtin</strong>，而到了Python3.X版本中，却更名为builtins</p>
<p>当使用内建模块中函数或其它功能时，可以直接使用，不用添加内建模块的名字;但是，如果想要向内建模块中添加一些功能，以便在任何函数中都能直接使用而不用再进行import，这时，就要导入内建模块，在内建模块的命名空间(即<strong>dict</strong>字典属性)中添加该功能。在导入时，如果是Python2.X版本，就要导入<strong>builtin</strong>模块;如果是Python3.X版本，就要导入builtins模块。</p>
<p>例如实现一个加法函数并导入内建变量</p>
<p>python2:<br><!--lang:python--></p>
<pre><code>import __builtin__
def add(x,y):
    return x+y
__builtin__.__dict__[&apos;add&apos;] = add
</code></pre><p>代码2-1</p>
<p>python3:<br><!--lang:python--></p>
<pre><code>import builtins
def add(x,y):
    return x+y
builtins.__dict__[&apos;add&apos;] = add
</code></pre><p>代码2-2</p>
<p>那<strong>builtins</strong>是什么呢</p>
<p><strong>builtins</strong>即是引用，那么它内建模块有一个相同点：Python程序一旦启动，它们二者就会在程序员所写的代码没有运行之前就已经被加载到内存中了</p>
<ol>
<li>在主模块<strong>main</strong>中：<br><strong>builtins</strong>是对内建模块<strong>builtin</strong>本身的引用，即<strong>builtins</strong>完全等价于<strong>builtin</strong>，二者完全是一个东西，不分彼此。它在任何地方都可见，即在任何地方都可使用它。此时，<strong>builtins</strong>的类型是模块类型。<br><strong>builtin</strong>仅仅在导入它时才可见。哪个作用域中使用<strong>builtin</strong>，哪个作用域就要导入它(导入仅仅是让<strong>builitin</strong>标识符在该作用域内可见)。一般都是在模块的顶层(即模块的全局作用域)导入<strong>builtin</strong>，这样，其后的任何作用域可通过标识符向上查找来引用<strong>builtin</strong>。</li>
<li>在非<strong>main</strong>模块中：<br><strong>builtins</strong>仅是对<strong>builtin</strong>.<strong>dict</strong>的引用，而非<strong>builtin</strong>本身。它在任何地方都可见。此时<strong>builtins</strong>的类型是字典。</li>
</ol>
<h2 id="再看eval"><a href="#再看eval" class="headerlink" title="再看eval"></a>再看eval</h2><p>eval(expression[, globals[, locals]])</p>
<p>当globals和locals为空时，expression运行在当前eval运行的全局名称空间和本地名称空间<br>当globals为空，locals不为空时，全局名称空间为当前eval运行的全局命名空间，本地名称空间为locals的传值<br>当globals不为空，expression的全局名称空间为globals（包括内置名称空间），如果locals为空，本地名称空间继承globals，如果locals不为空，expression的本地名称空间为locals<br><!--lang:python--></p>
<pre><code>g = &apos;I am global&apos;
def local():
    e = &apos;I am function&apos;
    if g is not None:
        l = &apos;I am local&apos;
        eval(&quot;e&quot;,None,&#123;&apos;m&apos;:123&#125;)  #NameError
        eval(&quot;l&quot;,None,&#123;&apos;m&apos;:123&#125;)  #NameError
        eval(&quot;g&quot;,None,&#123;&apos;m&apos;:123&#125;)  #&apos;I am global&apos;
        eval(&quot;g&quot;,&#123;&#125;,&#123;&apos;m&apos;:123&#125;)    #NameError
</code></pre>
            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2016/04/05/python_learn2/" style="float: left;">
        ← python shell交互与历史命令
    </a>
    
    
    <a class="pull-right" href="/2015/12/13/CentOS_openvpn/">
        基于公有云建设私有网络（三） →
    </a>
    
</nav>

        <div class="duoshuo">
<div class="ds-thread" data-thread-key="2016/03/31/python_learn1/" data-title="python eval踩坑后" data-url="http://tech.mts.cab/2016/03/31/python_learn1/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"franciscui"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By franciscui. All Rights Reserved.
                </p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/francisar" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/cpf382607308" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    <li><a href="http://weibo.com/u/2465175025/home" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
