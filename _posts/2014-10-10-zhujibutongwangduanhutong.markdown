---
layout: post
title:  "主机不同网段互通"
date:   2014/10/10 15:00:21
categories: 网络 路由
---
<p>前些天看了同学转载的一篇日志《同网段不同掩码之通信原理》<a href="http://www.yunsec.net/a/school/wlcs/agreement/2010/1016/6274.html">http://www.yunsec.net/a/school/wlcs/agreement/2010/1016/6274.html</a>，突然想到，同一链路不同网段是否可以通信。于是我做了一系列的实验。 <p>实验一：首先我用winxp的两台主机直接连一块儿 <table cellspacing="0" cellpadding="0"> <tbody> <tr> <td width="6"></td></tr> <tr> <td></td> <td><img title="clip_image001" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image001" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image001_3.png" width="244" height="48"></td></tr></tbody></table> <p>Xp1上我做了如下配置 <p><img title="clip_image002" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image002" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image002_3.png" width="223" height="244"> <p>Xp2上我做了如下配置 <p><img title="clip_image003" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image003" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image003_3.png" width="223" height="244"> <p>从xp1上ping xp2  <p><img title="clip_image004" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image004" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image004_3.png" width="244" height="120"> <p>以下是ping过程中的抓包 <p><img title="clip_image006" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image006" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image006_3.jpg" width="244" height="59"> <p>为什么能够ping通呢，我查看了下主机路由表netstat -r <p><img title="clip_image007" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image007" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image007_3.png" width="244" height="68"> <p>以前一直以为，主机（这里的主机指pc，与路由交换做区分）网关只能与主机在同一网段，主机只能进行同网段的arp询问，这个实验可以看出，windows主机在进行arp询问时，不关心询问地址与本地接口地址的关系（即是否在同一网段）。而且，即使网关与windows主机不在同一网段，也可以ping通。 <p>从上面实验，我猜想不同主机之间能否通讯，关键在于主机中的路由表，因此，我在以上两台主机上做了另外一个实验 <p>Xp1与xp2 ip地址以及掩码不变，但是我把网关删掉了 <p>然后打开命令提示符（cmd） <p>Xp1输入route add 11.1.1.0 mask 255.255.255.0 10.1.1.1 <p>Xp2输入 route add 10.1.1.0 mask 255.255.255.0 11.1.1.1 <p>（关于windows route命令，可以参考<a href="http://www.cnblogs.com/Real_Dream/articles/1577889.html">http://www.cnblogs.com/Real_Dream/articles/1577889.html</a>） <p>注：win7中使用route add需要管理员权限 <p>Xp1 ping xp2 结果通了 <p><img title="clip_image009" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image009" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image009_3.jpg" width="244" height="43"> <p>从这个实验可以看出windows的tcp/ip协议栈实现，到ip层时，也跟路由器一样，只查看是否有目的地址的路由，并不关心目的地址与源地址的关系。 <p>Windows的做完了，我又想到linux的是如何实现的呢 <p>于是，我用gns3-0.8搭建了如下拓扑 <p><img title="clip_image010" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image010" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image010_3.jpg" width="244" height="136"> <p>这两台主机是用gns3官网上提供的linux-microcore-3.8.2.img内核模拟的主机，关于gns3 qemu模拟器搭建可以参考<a href="http://bbs.spoto.net/thread-34653-1-1.html">http://bbs.spoto.net/thread-34653-1-1.html</a>。 <p>在qemu1上配置ip为10.1.1.1/24 <p>ifconfig eth0 10.1.1.1 netmask 255.255.255.0 <p>在qemu2上配置ip为11.1.1.1/24 <p>ifconfig eth0 11.1.1.1 netmask 255.255.255.0 <p>然后为两台主机分别添加网关 <p>route add default gw 10.1.1.1 <p>route add default gw 11.1.1.1 <p>（关于linux中route命令，可以参考<a href="http://www.ubooo.com/Linux/11008.html">http://www.ubooo.com/Linux/11008.html</a>） <p>从qemu1上ping qemu2 <p><img title="clip_image011" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image011" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image011_3.jpg" width="244" height="83"> <p>在qemu2上我开启了tcpdump抓包并过滤出arp <p><img title="clip_image013" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image013" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image013_3.jpg" width="244" height="35"> <p>之后，我又删除了默认网关，分别在两台主机上进行了如下设置 <p>route add -net 11.1.1.0 netmask 255.255.255.0 dev eth0 <p>route add -net 10.1.1.0 netmask 255.255.255.0 dev eth0 <p>依旧可以ping通 <p>在qemu2上我开启了tcpdump抓包并过滤出arp <p><img title="clip_image014" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image014" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image014_3.jpg" width="244" height="35"> <p>那么，路由器对于同一链路不同网段的互通以及arp又是怎么处理的，我用gns3搭建了以下拓扑 <p><img title="clip_image015" style="border-top: 0px; border-right: 0px; background-image: none; border-bottom: 0px; padding-top: 0px; padding-left: 0px; border-left: 0px; display: inline; padding-right: 0px" border="0" alt="clip_image015" src="http://francisar.github.io/images/2014-10-10/Windows-Live-Writer_c17b839f5b1e_D252_clip_image015_3.jpg" width="244" height="110"> <p>在这里，linux两台主机之间通信有两对arp，一对是icmp包交互之前，一对是在icmp包交互结束之后，不知道icmp包交互结束以后的arp包的目的是什么，望大神指点。 