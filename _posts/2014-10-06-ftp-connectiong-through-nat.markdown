---
layout: post
title:  "腾讯云服务器ftp服务客户端穿越nat连接问题"
date:   2014-10-06 12:03:28
categories: 网络 ftp
---



	腾讯云用户搭建ftp服务器，一直会遇到ftp登陆成功，但是无法列出目录的问题，由于ftp协议本身的特性以及腾讯云的网络架构，确实会有各种原因导
致ftp连接出现问题，为了能够更快速解决问题，因此对腾讯云服务器的ftp连接深入研究了下ftp列出目录失败，主要是数据连接的无法建立，而数据连接的
建立，在nat的环境下更为复杂，这里主要对客户端穿越nat连接腾讯云服务器ftp进行了分析
以下为分析的拓扑图
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp1.jpg" width="800">
ftp的数据连接建立主要分两种方式，主动和被动
（一）  主动FTP 
主动方式的FTP是这样的：客户端从一个任意的非特权端口N（N>1024）连接到FTP服务器的命令端口，也就是21端口。然后客户端开始监听端口N+1，并发送FTP
命令“port N+1”到FTP服务器。接着服务器会从它自己的数据端口（20）连接到客户端指定的数据端口（N+1）。
（二）  被动FTP
在被动方式FTP中，命令连接和数据连接都由客户端发起，当开启一个 FTP连接时，客户端打开两个任意的非特权本地端口（N &gt; 1024和N+1）。第一个端口
连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口，而是提交 PASV命令。这样做的结果是服务器会
开启一个任意的非特权端口（P &gt; 1024），并发送PORT P命令给客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。
	首先来分析上述拓扑中，客户端以主动模式连接ftp服务器的情况：
	在客户端，通过filezilla以主动模式连接腾讯云服务器10.143.81.9搭建的ftp服务器
	在客户端抓包
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp2.jpg" width="800">
	这里可以看出，客户端先访问服务器203.195.149.37+21端口，建立ftp控制连接，然后客户端会通过port命令，向服务器通告自己的ip以及监听端口
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp3.jpg" width="800">
	从抓包可以看到，通告的ip是10.3.68.31，端口是63087，但是这里有一个问题，客户端给服务器通告的是自己的内网IP，服务器通过这个ip寻址，必然无
法连接到客户端。但是本次测试，我的主动模式数据通信是成功的，是什么原因呢，那么再看下服务端的抓包
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp4.jpg" width="800">
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp5.jpg" width="800">
	从服务器端抓包看，客户端通告的端口是63087，跟客户端抓包是一致的，但是通告的IP发生了变化，变成了客户端网关的nat地址，因此服务器在主动模式
下建立数据连接时，可以成功与客户端建立连接。
	客户端port命令中通告的ip，其实是nat网关进行替换的，在这次ftp主动模式的连接中，客户端的nat网关首先更换了客户端port命令包中通告的ip，然后
在nat的地址转换槽中记录了一条从123.151.155.114：63087——》10.3.68.31：63087的一条映射，因此nat网关在接收到ftp服务器的数据连接请求包时，能够知
道要转发给10.3.68.31
	那么，在客户端穿越nat连接腾讯云服务器的ftp，需要客户端的nat网关支持以下功能
		1、 将主动连接中通告的ip替换	
		2、 需要在nat地址转换槽中保留一条映射记录
	如果客户端的nat网关不支持，那么就会导致主动模式连接腾讯云ftp服务器，数据连接建立失败。

	那么，客户端以被动模式连接服务器，又是什么样的情况呢
	再次在客户端，通过filezilla以被动模式连接腾讯云服务器10.143.81.9搭建的ftp服务器在服务器端抓包
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp6.jpg" width="800">
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp7.jpg" width="800">
	这里可以看出，服务器会向客户端通告自己的IP，以及端口10.143.81.9：51118，那么这里又有一个问题，服务器向客户端发送的是服务器内网IP，客户端
如何去连接呢
	我们再从客户端抓包再看
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp8.jpg" width="800">
<img src="/images/2014-10-06-ftp-connectiong-through-nat/ftp9.jpg" width="800">
	客户端接到的包，服务器发来的通告，内网IP被替换为了服务器的外网IP，端口没有变化，因此客户端仍然可以与服务器的203.195.149.37：51118建立数据
连接，这个IP的替换，其实是需要tgw来完成的

总的来看，腾讯云服务器ftp服务客户端穿越nat连接，主动模式需要看客户端的nat网关是否支持

1、 将主动连接中通告的ip替换

2、 需要在nat地址转换槽中保留一条映射记录

被动模式需要看腾讯云外部网关是否支持将被动模式通告IP：port包中的ip修改为服务器外网IP
